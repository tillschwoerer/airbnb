---
title: ""
author: "Tillmann Schw√∂rer"
date: "WS 2020/21"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: show  
    highlight: tango
    number_sections: true
---

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.height = 5, fig.width = 12)
```

# Packages
```{r}
library(tidyverse)
library(sf)
library(tmap)
library(osmdata)
library(RANN)
```

# Regression 
## Define Visualization Function
```{r}
options(scipen = 999)
```


```{r}
vis_residuals <- function(model, data, mode = "plot", textsize = 1){
  districts_n <- df %>% count(name) %>% st_drop_geometry()
  tmap_mode(mode)
  model %>% 
    broom::augment_columns(data) %>% 
    group_by(name) %>%
    summarise(error = mean(.resid), fitted = mean(.fitted), price = mean(price)) %>% 
    inner_join(districts, by = "name") %>%
    inner_join(districts_n, by = "name") %>%
    st_as_sf() %>% 
    tm_shape() + 
    tm_fill(col = "error", breaks = c(-70, -50, -30, -10, 10, 30, 50, 70), popup.vars = c("error", "price", "fitted")) + 
    tm_text(text = "n", size = textsize) +
    tm_borders()  
}
  
```



```{r}
model1 <- lm(price ~ room_type + size, data = df)
broom::augment(model1)
vis_residuals(model1, df, "view", textsize = 0.7)
```

```{r}
model <- lm(price ~ room_type + size + I(cut_number(n_restaurants, 4)), data = df)
summary(model)
vis_residuals(model, df, textsize = 0.7, mode = "view")
```
```{r}
model3 <- lm(price ~ accommodates + size + room_type + tv + bed_linens + parking + garden + coffeemaker + pool + bathtub + cooking_basics + gym + altbau + n_restaurants + n_attractions + stop_dist, data = df)
summary(model3)

vis_residuals(model3, df, textsize = 0.7, mode = "view")
```

